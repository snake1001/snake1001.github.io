---
title: "手搓PE之二：深入认识PE32基本结构--构造“最小”PE32可执行文件"
date: 2024-08-05
category: [basic]
tags: [Format]
img_path: /assets/images/
---

认识一个标准PE32可执行文件的基本结构，是我们学习二进制安全的第一步。在不增加新的知识和更多PE32格式的基础上，让我们换一个视角，来看看一个hacker是怎么认识这些数据结构的。个人认为hacker的最重要精神其实就是反对教条，对按部就班的教科书式的东西，喜欢折腾。
       本文是在《手搓PE32可执行文件》文章的基础上，通过打造更小的PE可执行文件，帮助读者深入理解PE32文件基本结构的本质。（实际上是windows不同版本下`Loader`的实现特点）。

导读提示：

* “最小”PE32可执行文件，只适配Win10系统，其他windows版本不一定能运行。因为不同版本windows的Loader对PE32格式的要求存在差异。
* 本文分三部分，引导读者循序渐进的逐步缩小PE32可执行文件的体积，最终打造一个“最小”的PE可执行文件。有兴趣的读者请在《手搓PE32可执行文件》中实现的PE32可执行文件的基础上进行操作。
* 本文表格结构和前文一致，但删除了不变的部分，有修改的地方用“删除线”标识，并给出修改后的值和说明。重点概念的深入理解部分会用文字详细描述。

## 第一步：深入认识 Section 的本质，Setion  三合一。

前文中我们手动构建了一个标准的PE32可执行文件，包含 PE Headers、.code 节、.data 节、.idata 节四部分。每个部分在PE文件中占 0x200 个字节。实际上我们通过构建过程可以发现，除了 PE Headers 部分，其他几个部分的有效数据非常少。

| Section Name | Valid Bytes |
| ------------ | ----------- |
| .code        | 0x15 = 21   |
| .data        | 0x42 = 66   |
| .idata       | 0x4A = 74   |
| total        | 0xA1 = 161  |

一共才 0xA1 = 161 个字节。远小于我们PE32文件中一个Section 512 个字节的大小。如果我们把三个节的有效内容都放到一个节里，不是可以让整个PE文件的大小减少一半吗！可PE32文件我们看到的都是由 .code、.data、.idata 这些节组成的，可以把不同的数据放到一起吗？

还真可以！让我们来破除这些将Section分门别类的“执念”，深入理解`Section`的本质：

我们常见的教科书里讲的”.code、.data、.idata“等的约定，实际上是上层语言、编译器等的约定俗成的分类。在安全角度来说，不同的”格子“分类，也可以适用不同的安全策略。比如Section Table结构里的 Characteristics 字段。而我们这是手动编辑一个二进制文件，站在编译器、编程语言的更下层，完全可以抛弃这些“约定俗成”。

在 PE32 文件的基本结构设计和 Windows Loader 的角度考察，Section 仅仅相当于一个容器。提供存放用户“数据”（代码、资源、各种结构数据等）的一个空间。多个Section就提供了多个这样的空间。如同家里的衣柜，分了很多格子。至于这些格子放什么，基本上是由用户决定的。重要的Loader需要的数据实际上都在头文件里面设置了“指针”字段，并不是依靠Section的分类来获取的。比如 PE Optional Header 的 `AddressOfEntryPoint` 字段，指向“用户代码”（高级语言编译器会加入前置代码，在这个场景下，也属于“用户代码”）的入口点。比如 `data-diretory` 结构的数组，每一项都指向 Loader 需要的重要数据。

根据上面的分析，我们就知道，既然手动编译一个PE32可执行文件，我们完全可以把3个Section的数据都放到1个Section里面，只要能放得下。这样可以将我们的PE32文件大小减小一半。来让我们动手干吧。

### 1、重新布局内容

* 创建一个 0x400 大小的全零的二进制文件 min_PE1.0.exe
* 拷贝前文创建PE32可执行文件的前 0x400 个字节。（File Headers + .code Section）
* 将 .data 和 .idata 节的数据拷贝到 .code 节中

![]({{ page.name | remove: '.md' }}/min_PE1.png)

我的布局是将 .idata 的导入表数据放到了 0x320 处，.data 的字符串数据放到了 0x260 处。（图中红色部分）

读者也可以自行安排，甚至改变 code 的位置。