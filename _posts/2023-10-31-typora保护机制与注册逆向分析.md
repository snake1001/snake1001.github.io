---
title: "typora保护机制与注册逆向分析"
date: 2023-10-31
category: [crack]
tags: [破解]
img_path: /assets/images/
---

## 一、起因
一直比较喜欢Typora的简洁与美观（尝试过用 vscode 搭配插件编辑 markdown 文件，体验还是要差一些的），突然发现自己windows机器上很久前安装的typora不让用了，提示：  
![版本过期](1.png)  
幸好原始安装文件还在，对比一下版本，原始安装文件是 0.9.93 版本，而不让用的是 0.10.11。  
在我的 ubuntu22.04 机器上安装有 1.7.4 版本，win10上安装了 1.7.6版本。貌似最新的版本开始收费了，还分国内/国外两个版本。（typora.io 这个官网貌似被墙了，真不知道为了个啥。）
本着一个cracker无知者无畏的折腾到底的精神，开始瞎整！

## 二、摸底、知识和工具准备
`😀 逆向分析的第一步就是要了解目标软件是用啥开发的，架构是啥。`  
一看 typora.exe 好家伙，100多个M，这么大的可执行程序还分析个啥？IDA分析一下都不知道要多久。  
由于目前主用 ubuntu22.04 系统，想着顺便从 0 开始学习使用 ghidra 进行 Linux 平台的逆向分析工作。于是从一个小目标开始，需要瞎搞的知识点有了第一次扩充。  
ubuntu平台，用ghidra分析 1.7.4 版本；  
win7平台，用IDA6.8+x64DBG分析0.10.11版本；  
win10平台，用IDA6.8+x64DBG分析 1.7.6版本。（1.7.6 在我的win7下会出现不能在kernel32里面定位 discardVirtualMemory的错误）  
悲催的是用 ghidra 静态分析 1.7.4 版本的 typora 有160多M，分析了10个小时也没结束。这个弯路绕太远了，毫无意义。直接放弃。  
正确的打开方式：直接网上搜索  
有大神直接用 IDA 分析 typora.exe，提示了一些有用的东东。结合两位成功破解的大神的文章，可以确定 typora 是使用 electron + nodejs 框架，用 javascript 开发的跨平台的桌面程序。（和vscode类似）  
所以，啥是 electron/nodejs/javascript？0 基础的暴走，奇怪的知识点需要进行第二次扩充。electron 框架（nodejs和V8引擎）  
这几个每一个都是大部头，越底层的难度越大。被V8引擎绕进去花了不少时间（虽然了解一下好处很多，带着VM的思路去了解，能有不少收获），但就typora的破解来说，只需要涉猎以下内容：  
electron app 的目录结构。  
asar 打包/解压工具 (npm i -g asar)  
node.js： 模块/API/运行环境构建/npm工具；node 命令行环境下运行 js 代码（类似python命令行环境）  
V8 引擎：几乎用不到，因为用到了 Addon N-API 接口库。当然了解V8的好处还是很多的。真实的托管类数据结构，都是在V8引擎里面定义的，有详细的参考手册。  
node.js Addon：通过 C++ 编写的扩展模块，用于扩展 Node.js 的功能。这个是重点，需要知道怎么写扩展模块的基本逻辑。（至少了解 V8 和 C++ 相互调用变量/函数的一两个例子）  
N-API（Node-API）是一组稳定的 C 语言 API，用于编写跨平台的 Node.js Addon。N-API 提供了一套抽象层，使得开发者可以更轻松地编写可移植的扩展模块，而无需担心不同版本的 Node.js 或不同平台之间的兼容性问题。  
这个是需要重点把握的，熟练查阅 nods.js 中 N-API 的文档。  
N-API 实际上是 V8 接口的封装，进行了抽象，但对逆向增加了困难。因为其参数都是一系列 void** 之类的指针，具体在 V8 层进行实际的数据类型转换。所以逆向时，对于托管对象的指针，就别想着查看其数据了。重点应该放在 C++ 的本地数据结构上。   

